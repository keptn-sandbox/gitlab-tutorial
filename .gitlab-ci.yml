#
# Dynatrace Demo CI/CD Pipeline
#

#################################################################
# Global Variables
#################################################################
variables:
  APPLICATION_NAME: sample-app

include: 
  - local: 'ci-includes/dt_deploy-eks-oneagent.yml'


stages:
  - aws-eks-provisioning
  - configure-dynatrace

#################################################################
# Provisioning Stage
#################################################################
create-aws-environment:
  stage: aws-eks-provisioning
  image: registry.gitlab.com/checkelmann/cicd-tools:latest
  environment:
      name: test
  variables:
      GIT_STRATEGY: none
  script:
      - eksctl create cluster --config-file assets/cluster.yml --kubeconfig aws.kubeconfig
      - export KUBECONFIG=./aws.kubeconfig
      - kubectl apply -f assets/helm-rbac.yml
      - helm init --service-account tiller
      - helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator
      - helm install incubator/aws-alb-ingress-controller --set autoDiscoverAwsRegion=true --set autoDiscoverAwsVpcID=true --set clusterName=dynatrace-demo
  when: manual

deploy_oneagent:
  stage: configure-dynatrace
  extends: .dt_deploy-eks-oneagent
  environment:
    name: test
  when: manual