#
# Dynatrace Demo CI/CD Pipeline
#

#################################################################
# Global Variables
#################################################################
#################################################################
# Include necessary Templates 
#################################################################
include:  
  - project: 'checkelmann/dynatrace-pipeline'
    ref: master
    file: '/ci-includes/dt_deploy-eks-oneagent.yml'
  - project: 'checkelmann/dynatrace-pipeline'
    ref: master
    file: '/ci-includes/dt_configure_tenant.yml'

stages:
  - aws-eks-provisioning
  - aws-eks-oneagent
  - aws-eks-keptn
  - configure-dynatrace

#keptn-test:
#  stage: keptn-test
#  image: registry.gitlab.com/checkelmann/cicd-tools:latest
#  environment:
#    name: test
#  variables:
#      GIT_STRATEGY: none
#  script:
    #- echo $KUBECONFIG
    #- cat $KUBECONFIG
    #- echo $KUBE_URL
    #- echo $KUBE_CA_PEM_FILE


#################################################################
# Provisioning Stage
#################################################################
create-aws-environment:
  stage: aws-eks-provisioning
  image: registry.gitlab.com/checkelmann/cicd-tools:latest
  variables:
      GIT_STRATEGY: none
  script: |
    curl -o cluster.yml https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/cluster.yml
    curl -o helm-rbac.yml https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/helm-rbac.yml
    curl -o eks-service-account.yml https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/eks-service-account.yml
    curl -o dt_k8s_config.json https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/dt_k8s_config.json
    eksctl create cluster --config-file cluster.yml --kubeconfig aws.kubeconfig
    export KUBECONFIG=./aws.kubeconfig
    kubectl apply -f helm-rbac.yml
    kubectl apply -f eks-service-account.yml
    python /sendslack.py "Kubeconfig for Cluster" --attachment $(pwd)/aws.kubeconfig
    echo "Getting Secrets..."
    kubectl get secret $(kubectl get secrets|grep default|awk '{print $1}') -o jsonpath="{.data.ca\.crt}"|base64 -d > cert.pem
    export K8STOKEN=$(kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep eks-admin | awk '{print $1}')|grep "token:"|awk '{print $2}')
    export K8SAPI=$(cat aws.kubeconfig|grep "server:"|awk '{print $2}')
    export K8S_NAME=$(yq r cluster.yml metadata.name)
    python /sendslack.py "API Url @${K8SAPI} with Token ${K8STOKEN}" 
    echo "Sending cert...."
    python /sendslack.py "Certificate" --attachment $(pwd)/cert.pem
    echo "Sending Config...."
    python /sendslack.py "Kubeconfig for Cluster" --attachment $(pwd)/aws.kubeconfig

    echo "Adding Cluster to Dynatrace"
    API="https://${DT_TENANT_ID}.live.dynatrace.com/api/config/v1/kubernetes/credentials"
    envsubst < dt_k8s_config.json > tmp.json
    curl -s -H "Authorization: Api-Token ${DT_API_TOKEN}" -H 'Content-Type: application/json' -X POST ${API} -d @tmp.json

    echo "Installing Helm"
    helm init --service-account tiller
    echo "Wait for tiller to be ready..."

    for i in $(seq 1 20);
    do
      helmready=$(kubectl get po -n kube-system|grep tiller|awk '{print $3}')
      echo $helmready
      if [ "$helmready" = "Running" ];
      then
        echo "Tiller is ready"
        break
      fi
      echo $i
      sleep 5
    done

    if [ "$helmready" != "Running" ];
    then
      echo "Helm installation failed!"
      exit 1
    fi
    kubectl logs $(kubectl get po -n kube-system|grep tiller|awk '{print $1}') -n kube-system
    sleep 10

    helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator
    helm install incubator/aws-alb-ingress-controller --set autoDiscoverAwsRegion=true --set autoDiscoverAwsVpcID=true --set clusterName=dynatrace-demo
    python /gitlab.py
  when: manual

install-keptn:
  stage: aws-eks-keptn
  image: registry.gitlab.com/checkelmann/cicd-tools:latest
  environment:
    name: test
  variables:
      GIT_STRATEGY: none
  script: |
    curl -o cluster.yml https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/cluster.yml    
    cluster_name=$(yq r cluster.yml metadata.name)
    cluster_region=$(yq r cluster.yml metadata.region)
    curl -o creds.json https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/keptn_creds.json
    sed -i -- s/CLUSTER_NAME_PLACEHOLDER/${cluster_name}/g creds.json
    sed -i -- s/AWS_REGION/${cluster_region}/g creds.json
    mkdir ~/.kube
    cp $KUBECONFIG ~/.kube/config    
    eksctl utils update-coredns --name=${cluster_name} --region=${cluster_region} --approve
    echo "Waiting for CoreDNS Update..."
    sleep 20
    keptn install --platform=eks -c=creds.json --keptn-version=0.5.2|tee inst.out
    export ZONE_ID=$(aws route53 list-hosted-zones-by-name --dns-name=${AWS_ROUTE53_DOMAIN}|jq ".HostedZones[0].Id"|grep -o -P '(?<=hostedzone/).*(?=")')
    export KEPTN_ENDPOINT=$(cat inst.out|grep "set for"|awk {'print $13'})
    aws route53 change-resource-record-sets --hosted-zone-id "${ZONE_ID}" --change-batch "{\"Changes\":[{\"Action\":\"CREATE\",\"ResourceRecordSet\":{\"Name\":\"*.${AWS_ROUTE53_DOMAIN}.\",\"Type\":\"CNAME\",\"TTL\":60,\"ResourceRecords\":[{\"Value\":\"${KEPTN_ENDPOINT}\"}]}}]}" --region us-east-1
    echo "Wait 60sec for DNS Record beeing updated"
    sleep 60
    echo y|keptn configure domain ${AWS_ROUTE53_DOMAIN}
    echo "Configure GitLab CI/CD Variable"
    export KEPTN_API=$(head -1 ~/.keptn/.keptn)
    export KEPTN_TOKEN=$(tail -1 ~/.keptn/.keptn)
    #POST /projects/:id/variables
    GL_API="${CI_API_V4_URL}projects/${CI_PROJECT_ID}/variables"

    TOKEN_EXISTS=$(curl -s --header "PRIVATE-TOKEN: ${GL_API_TOKEN}" $GL_API | jq '.[] | select (.key=="KEPTN_TOKEN")')
    if [ "$TOKEN_EXISTS" = "" ]; then
      noout=$(curl -s --request POST -H "PRIVATE-TOKEN: ${GL_API_TOKEN}" $GL_API --form "key=KEPTN_TOKEN" --form "value=${KEPTN_TOKEN}")
    else
      noout=$(curl -s --request PUT -H "PRIVATE-TOKEN: ${GL_API_TOKEN}" $GL_API/KEPTN_TOKEN --form "value=${KEPTN_TOKEN}")
    fi
    KEPTN_API_EXISTS=$(curl -s --header "PRIVATE-TOKEN: ${GL_API_TOKEN}" $GL_API | jq '.[] | select (.key=="KEPTN_API")')
    if [ "$TOKEN_EXISTS" = "" ]; then
      noout=$(curl -s --request POST -H "PRIVATE-TOKEN: ${GL_API_TOKEN}" $GL_API --form "key=KEPTN_API" --form "value=${KEPTN_API}")
    else
      noout=$(curl -s --request PUT -H "PRIVATE-TOKEN: ${GL_API_TOKEN}" $GL_API/KEPTN_API --form "value=${KEPTN_API}")
    fi    
  when: manual  

dt_deploy-eks-oneagent:
  environment:
    name: test
  when: manual

dt_configure_tenant:
  environment:
    name: test
  when: manual