#
# Dynatrace Demo CI/CD Pipeline
#

#################################################################
# Global Variables
#################################################################
#################################################################
# Include necessary Templates 
#################################################################
#include:  
#  - project: 'checkelmann/dynatrace-pipeline'
#    ref: master
#    file: '/ci-includes/dt_deploy-eks-oneagent.yml'
#  - project: 'checkelmann/dynatrace-pipeline'
#    ref: master
#    file: '/ci-includes/dt_configure_tenant.yml'

stages:
  - aws-eks-provisioning
  - aws-eks-keptn

#################################################################
# Provisioning Stage
#################################################################
create-aws-environment:
  stage: aws-eks-provisioning
  image: registry.gitlab.com/checkelmann/cicd-tools:latest
  variables:
      GIT_STRATEGY: none
  script:
      - curl -o cluster.yaml https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/cluster.yml
      - curl -o helm-rbac.yml https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/helm-rbac.yml
      - eksctl create cluster --config-file cluster.yml --kubeconfig aws.kubeconfig
      - export KUBECONFIG=./aws.kubeconfig
      - kubectl apply -f helm-rbac.yml
      - helm init --service-account tiller
      - helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator
      - helm install incubator/aws-alb-ingress-controller --set autoDiscoverAwsRegion=true --set autoDiscoverAwsVpcID=true --set clusterName=dynatrace-demo
  when: manual

install-keptn:
  stage: aws-eks-keptn
  image: registry.gitlab.com/checkelmann/cicd-tools:latest
  variables:
      GIT_STRATEGY: none
  script: |
    curl -o cluster.yaml https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/cluster.yml    
    cluster_name=$(yq r cluster.yaml metadata.name)
    cluster_region=$(yq r cluster.yaml metadata.region)
    curl -o creds.json https://gitlab.com/checkelmann/dynatrace-pipeline/raw/master/assets/keptn_creds.json
    sed -i -- s/CLUSTER_NAME_PLACEHOLDER/${cluster_name}/g creds.json
    sed -i -- s/AWS_REGION/${cluster_region}/g creds.json
    eksctl utils update-coredns --name=${cluster_name} --region=${cluster_region} --approve
    keptn install --platform=eks -c=creds.json --keptn-version=0.5.2
  when: manual  

#deploy_oneagent:
#  stage: configure-dynatrace
#  extends: .dt_deploy-eks-oneagent
#  environment:
#    name: test
#  when: manual